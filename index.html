<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flappy Shape</title>
    <!-- Import the p5.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
    </style>
</head>
<body>
    <script>
        // --- Game Variables ---
        let bird;
        let pipes = [];
        
        // Game settings
        let basePipeSpeed = 3;         // Starting speed
        let pipeSpeed;                 // Dynamic speed
        const speedGrowthRate = 1.001; // How quickly speed increases
        const pipeGap = 200;           // Space between top and bottom pipes
        const pipeWidth = 80;
        const pipeFrequency = 100;     // Add a new pipe every 100 frames
        const gravity = 0.6;
        const jump = -10;
        const gameOverHitCount = 5;

        // Game state
        let gameOver = false;
        let hitPipes; // Set to store unique pipe IDs

        // Game Over button properties
        let btnX, btnY, btnW, btnH;

        // --- p5.js Core Functions ---

        function setup() {
            createCanvas(windowWidth, windowHeight);
            
            // Initialize the bird object
            bird = {
                x: width / 4,
                y: height / 2,
                size: 50,
                velocity: 0
            };

            hitPipes = new Set();
            
            // Define button properties for the retry button
            btnW = 140;
            btnH = 60;
            btnX = width / 2 - btnW / 2;
            btnY = height / 2 + 40;
        }

        function draw() {
            background(135, 206, 235); // Sky blue

            // Exponentially increase pipe speed over time
            pipeSpeed = basePipeSpeed * pow(speedGrowthRate, frameCount);
            pipeSpeed = min(pipeSpeed, 20); // Cap the max speed so itâ€™s not impossible

            if (gameOver) {
                drawGameOverScreen();
            } else {
                updateBird();
                drawBird();
                managePipes();
                drawHitCount();
            }
        }

        function mousePressed() {
            if (gameOver) {
                // If game over, check if mouse is clicking the Retry button
                if (mouseX > btnX && mouseX < btnX + btnW && mouseY > btnY && mouseY < btnY + btnH) {
                    location.reload();
                }
            } else {
                // Flap up
                bird.velocity = jump;
            }
        }

        function windowResized() {
            resizeCanvas(windowWidth, windowHeight);
            btnX = width / 2 - btnW / 2;
            btnY = height / 2 + 40;
        }

        // --- Game Logic ---

        function updateBird() {
            bird.velocity += gravity;
            bird.y += bird.velocity;
            bird.velocity *= 0.95; // Air resistance
            bird.y = constrain(bird.y, bird.size / 2, height - bird.size / 2);
        }

        function managePipes() {
            // Add new pipe every 'pipeFrequency' frames
            if (frameCount % pipeFrequency === 0) {
                let topHeight = random(100, height - 100 - pipeGap);
                pipes.push({
                    x: width,
                    topHeight: topHeight,
                    id: frameCount, // Unique ID
                    isHit: false
                });
            }

            // Loop through pipes (back to front)
            for (let i = pipes.length - 1; i >= 0; i--) {
                let pipe = pipes[i];
                pipe.x -= pipeSpeed; // Move pipe based on growing speed

                // Check for collision before drawing
                if (!pipe.isHit && checkCollision(bird, pipe)) {
                    pipe.isHit = true;
                    hitPipes.add(pipe.id);

                    if (hitPipes.size >= gameOverHitCount) {
                        gameOver = true;
                    }
                }

                // Pipe color
                if (pipe.isHit) {
                    fill(255, 0, 0, 200); // Red if hit
                } else {
                    fill(0, 200, 0); // Green
                }

                stroke(0);
                strokeWeight(2);

                // Draw pipes
                rect(pipe.x, 0, pipeWidth, pipe.topHeight);
                rect(pipe.x, pipe.topHeight + pipeGap, pipeWidth, height - pipe.topHeight - pipeGap);

                // Remove off-screen pipes
                if (pipe.x < -pipeWidth) {
                    pipes.splice(i, 1);
                }
            }
        }

        // --- Collision Detection ---

        function checkCollision(b, p) {
            // Bird bounding box
            let b_left = b.x - b.size / 2;
            let b_right = b.x + b.size / 2;
            let b_top = b.y - b.size / 2;
            let b_bottom = b.y + b.size / 2;

            // Top pipe
            let p_top_left = p.x;
            let p_top_right = p.x + pipeWidth;
            let p_top_bottom = p.topHeight;

            // Bottom pipe
            let p_bottom_left = p.x;
            let p_bottom_right = p.x + pipeWidth;
            let p_bottom_top = p.topHeight + pipeGap;

            // Check overlap
            let hitsTop = (b_left < p_top_right && b_right > p_top_left && b_top < p_top_bottom);
            let hitsBottom = (b_left < p_bottom_right && b_right > p_bottom_left && b_bottom > p_bottom_top);

            return hitsTop || hitsBottom;
        }

        // --- Drawing ---

        function drawBird() {
            // Body
            fill(255, 255, 0);
            stroke(0);
            strokeWeight(2);
            ellipse(bird.x, bird.y, bird.size, bird.size);

            // Beak with black lineart
            fill(255, 165, 0);
            stroke(0);
            strokeWeight(2);
            let beakLength = bird.size / 3;
            let beakHeight = bird.size / 3;
            let baseX = bird.x + bird.size / 2;
            let tipX = baseX + beakLength;

            triangle(
                baseX, bird.y - beakHeight / 2,
                baseX, bird.y + beakHeight / 2,
                tipX, bird.y
            );
        }

        function drawHitCount() {
            fill(255);
            stroke(0);
            strokeWeight(3);
            textSize(32);
            textAlign(LEFT, TOP);
            text("Lives Lost: " + hitPipes.size + " / " + gameOverHitCount, 10, 10);
        }

        function drawGameOverScreen() {
            fill(0, 0, 0, 150);
            rect(0, 0, width, height);

            fill(255, 0, 0);
            noStroke();
            textSize(64);
            textAlign(CENTER, CENTER);
            text("Game Over", width / 2, height / 2 - 80);

            fill(255);
            textSize(32);
            text("You lost all " + hitPipes.size + " lives!", width / 2, height / 2 - 10);

            fill(100, 255, 100);
            stroke(0);
            strokeWeight(2);
            rect(btnX, btnY, btnW, btnH, 10);

            fill(0);
            noStroke();
            textSize(28);
            text("Retry", width / 2, btnY + btnH / 2 + 2);
        }
    </script>
</body>
</html>
